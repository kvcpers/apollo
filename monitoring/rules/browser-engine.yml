# Chrome Browser Engine - Prometheus Alerting Rules
# Production alerting configuration

groups:
  - name: browser-engine.rules
    rules:
      # High memory usage
      - alert: BrowserEngineHighMemoryUsage
        expr: browser_engine_memory_usage_bytes / browser_engine_memory_limit_bytes > 0.8
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine high memory usage"
          description: "Browser Engine memory usage is above 80% for more than 5 minutes"

      # Critical memory usage
      - alert: BrowserEngineCriticalMemoryUsage
        expr: browser_engine_memory_usage_bytes / browser_engine_memory_limit_bytes > 0.95
        for: 2m
        labels:
          severity: critical
          service: browser-engine
        annotations:
          summary: "Browser Engine critical memory usage"
          description: "Browser Engine memory usage is above 95% for more than 2 minutes"

      # High CPU usage
      - alert: BrowserEngineHighCPUUsage
        expr: rate(browser_engine_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine high CPU usage"
          description: "Browser Engine CPU usage is above 80% for more than 5 minutes"

      # Service down
      - alert: BrowserEngineDown
        expr: up{job="browser-engine"} == 0
        for: 1m
        labels:
          severity: critical
          service: browser-engine
        annotations:
          summary: "Browser Engine is down"
          description: "Browser Engine service has been down for more than 1 minute"

      # High error rate
      - alert: BrowserEngineHighErrorRate
        expr: rate(browser_engine_http_requests_total{status=~"5.."}[5m]) / rate(browser_engine_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine high error rate"
          description: "Browser Engine error rate is above 5% for more than 5 minutes"

      # High response time
      - alert: BrowserEngineHighResponseTime
        expr: histogram_quantile(0.95, rate(browser_engine_http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine high response time"
          description: "Browser Engine 95th percentile response time is above 2 seconds"

      # Low throughput
      - alert: BrowserEngineLowThroughput
        expr: rate(browser_engine_http_requests_total[5m]) < 10
        for: 10m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine low throughput"
          description: "Browser Engine throughput is below 10 requests/second for more than 10 minutes"

      # Disk space low
      - alert: BrowserEngineLowDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/app"} / node_filesystem_size_bytes{mountpoint="/app"}) < 0.1
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine low disk space"
          description: "Browser Engine disk space is below 10%"

      # Network connectivity issues
      - alert: BrowserEngineNetworkIssues
        expr: rate(browser_engine_network_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine network issues"
          description: "Browser Engine network error rate is above 0.1 errors/second"

      # JavaScript engine errors
      - alert: BrowserEngineJSErrors
        expr: rate(browser_engine_js_errors_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine JavaScript errors"
          description: "Browser Engine JavaScript error rate is above 0.5 errors/second"

      # Layout engine performance
      - alert: BrowserEngineLayoutSlow
        expr: histogram_quantile(0.95, rate(browser_engine_layout_duration_seconds_bucket[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine slow layout"
          description: "Browser Engine layout calculation is slow (95th percentile > 100ms)"

      # Rendering engine performance
      - alert: BrowserEngineRenderingSlow
        expr: histogram_quantile(0.95, rate(browser_engine_rendering_duration_seconds_bucket[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine slow rendering"
          description: "Browser Engine rendering is slow (95th percentile > 50ms)"

      # Cache hit rate low
      - alert: BrowserEngineLowCacheHitRate
        expr: rate(browser_engine_cache_hits_total[5m]) / (rate(browser_engine_cache_hits_total[5m]) + rate(browser_engine_cache_misses_total[5m])) < 0.7
        for: 10m
        labels:
          severity: warning
          service: browser-engine
        annotations:
          summary: "Browser Engine low cache hit rate"
          description: "Browser Engine cache hit rate is below 70% for more than 10 minutes"

      # Memory leaks
      - alert: BrowserEngineMemoryLeak
        expr: increase(browser_engine_memory_usage_bytes[1h]) > 100 * 1024 * 1024
        for: 30m
        labels:
          severity: critical
          service: browser-engine
        annotations:
          summary: "Browser Engine potential memory leak"
          description: "Browser Engine memory usage increased by more than 100MB in the last hour"

      # Process crashes
      - alert: BrowserEngineProcessCrashes
        expr: increase(browser_engine_process_crashes_total[1h]) > 0
        for: 0m
        labels:
          severity: critical
          service: browser-engine
        annotations:
          summary: "Browser Engine process crashes"
          description: "Browser Engine process has crashed"

      # Resource exhaustion
      - alert: BrowserEngineResourceExhaustion
        expr: browser_engine_memory_usage_bytes / browser_engine_memory_limit_bytes > 0.99
        for: 1m
        labels:
          severity: critical
          service: browser-engine
        annotations:
          summary: "Browser Engine resource exhaustion"
          description: "Browser Engine is approaching resource limits (99% memory usage)"
